esphome:
  on_loop:
    then:
      - if:
          condition:
            not:
              - script.is_running: pulse_led
          then:
            - script.execute: pulse_led

script:
  - id: pulse_led
    then:
      - lambda: |-
          if (!(wifi_wificomponent->is_connected())) {
            id(connection_status) = 1;
          } else if (!(api_apiserver->is_connected())) {
            id(connection_status) = 2;
          } else {
            id(connection_status) = 0;
          }
          if (id(connection_status) != 0) {
            if (id(connection_progress_bar) + 1 > 4) {
              id(connection_progress_bar) = 2;
            } else {
              id(connection_progress_bar) += 1;
            }
          } else {
            id(connection_progress_bar) = 0;
          }
      - if:
          condition:
            lambda: 'return (id(connection_status) == 1);'
          then:
            - if:
                condition:
                  lambda: 'return id(relay_status) != 0;'
                then:
                  - script.execute: pulse_led_relay_on_wifi
                  - script.wait: pulse_led_relay_on_wifi
                  - script.execute: check_relay_then_turn_light_on_off
                  - script.wait: check_relay_then_turn_light_on_off
                else:
                  - script.execute: pulse_led_standard_wifi
                  - script.wait: pulse_led_standard_wifi
                  - script.execute: check_relay_then_turn_light_on_off
                  - script.wait: check_relay_then_turn_light_on_off
          else:
            - if:
                condition:
                  lambda: 'return (id(connection_status) == 2);'
                then:
                  - if:
                      condition:
                        lambda: 'return id(relay_status) != 0;'
                      then:
                        - script.execute: pulse_led_relay_on_api
                        - script.wait: pulse_led_relay_on_api
                        - script.execute: check_relay_then_turn_light_on_off
                        - script.wait: check_relay_then_turn_light_on_off
                      else:
                        - script.execute: pulse_led_standard_api
                        - script.wait: pulse_led_standard_api
                        - script.execute: check_relay_then_turn_light_on_off
                        - script.wait: check_relay_then_turn_light_on_off
      
  - id: run_timer_seconds
    then:
       - if:
            condition:
               - lambda: 'return id(timer_time) > 0;'
            then:
               - logger.log:
                    format: "Starting Relay"
               - script.execute: turn_on_template_relay_id

  - id: timer_end_sequence
    then:
       - script.execute: turn_off_template_relay_id
       - lambda: 'id(timer_time) = 0;'
       - lambda: 'id(template_relay_id) = 0;'
